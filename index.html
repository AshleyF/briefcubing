<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Brief Cubing</title>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-75630988-2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-75630988-2');
        </script>
        <meta charset="UTF-8">
        <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" href="jquery/jquery.mobile-1.4.5.min.css" />
        <link rel="stylesheet" href="theme-classic.css" />
        <script src="jquery/jquery-1.11.1.min.js"></script>
        <script src="jquery/jquery.mobile-1.4.5.min.js"></script>
        <script src="roofpig_and_three.min.js"></script>
        <script src="cube.js"></script>
        <script src="display.js"></script>
        <script src="giiker.js"></script>
        <script src="settings.js"></script>
        <script src="algs.js"></script>
        <script src="ui.js"></script>
        <script src="nosleep.min.js"></script>
        <script>
            const version = "0.1.3";
            var nosleep = new NoSleep();

            $(window).resize(setMainHeightToFit);

            function setMainHeightToFit() {
                var screenHeight = $.mobile.getScreenHeight();
                var header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight()  - 1 : $(".ui-header").outerHeight();
                var footer = $(".ui-footer").hasClass("ui-footer-fixed") ? $(".ui-footer").outerHeight() - 1 : $(".ui-footer").outerHeight();
                var contentHeight = $(".ui-content").outerHeight() - $(".ui-content").height();
                var content = screenHeight - header - footer - contentHeight;
                $(".ui-content").height(content);
            }

            $(document).on("pagecreate", "#main", function() {
                buildAlgOptions();
            });

            $(document).on("pagebeforeshow", "#main", function(event) {
                setMainHeightToFit();
                if (!Giiker.connected()) Ui.showConnectButton();
                Ui.next();
            });

            $(document).on("panelbeforeopen", "#options", function() {
                settingsToUi();
            });

            $(document).keypress(function(e) {
                switch (e.which) {
                    case 13:
                        document.getElementById("debug").style.display = "";
                        break;
                }
            });

            var colors = ["yellow", "white", "red", "orange", "green", "blue"];

            function settingsToUi() {
                $("#auf").prop('value', Settings.values.randomAuf ? "on" : "off").slider('refresh');
                $("#simple").prop('value', Settings.values.simpleDiagram ? "on" : "off").slider('refresh');
                for (var c in Settings.values.upColors) {
                    $('#' + c).prop('checked', Settings.values.upColors[c]).checkboxradio('refresh');
                }
                for (var a in Settings.values.algs) {
                    var id = Settings.values.algs[a];
                    $('#' + id).prop('checked', true).checkboxradio('refresh');
                }
                settingsUpdate(); // consistency checks
            }

            function settingsUpdate() {
                Settings.values.randomAuf = document.getElementById("auf").value == "on";
                Settings.values.simpleDiagram = document.getElementById("simple").value == "on";
                var upcols = Settings.values.upColors;
                for (var c in colors) {
                    var col = colors[c];
                    upcols[col] = document.getElementById(col).checked;
                }
                if (!upcols.yellow && !upcols.white && !upcols.red && !upcols.orange && !upcols.green && !upcols.blue) {
                    $("#yellow").prop('checked', true).checkboxradio('refresh'); // default
                    upcols.yellow = true;
                }
                Settings.values.algs = [];
                for (var s in Algs.sets) {
                    var set = Algs.sets[s];
                    var some = false;
                    var all = true;
                    for (var a in set.algs) {
                        var id = s + '_' + set.algs[a].id;
                        var cb = document.getElementById(id);
                        if (cb && cb.checked) {
                            some = true;
                            Settings.values.algs.push(id);
                        } else {
                            all = false;
                        }
                    }
                    $('#' + s).prop('checked', all).checkboxradio('refresh');
                    document.getElementById(s + "_title").style.color = (some ? "#6ad" : "white");
                }
                Settings.save();
                Ui.next();
            }

            function settingsAllCasesUpdate(name) {
                var all = document.getElementById(name).checked;
                var set = Algs.sets[name];
                for (var a in set.algs) {
                    $('#' + name + '_' + set.algs[a].id).prop('checked', all).checkboxradio('refresh');
                }
                settingsUpdate();
            }

            function upColorToRot() {
                var upcols = Settings.values.upColors;
                if (upcols.yellow) return "";
                if (upcols.white) return "x2";
                if (upcols.red) return "x";
                if (upcols.orange) return "x'";
                if (upcols.green) return "z'";
                if (upcols.blue) return "z";
            }

            var lastRot = undefined;
            function buildAlgOptions() {
                var rot = upColorToRot();
                if (rot == lastRot) return;
                lastRot = rot;
                var htm = "";
                for (var s in Algs.sets) {
                    var set = Algs.sets[s];
                    htm += '<div id="cmllFieldset" data-role="collapsible"><h3><span id="' + s + '_title">' + set.name + '</span></h3>';
                    htm += '<input id="' + s + '" type="checkbox" onchange="settingsAllCasesUpdate(\'' + s + '\')" data-mini="true" /><label for="' + s + '">All ' + set.name + ' Cases</label>';
                    htm += '<fieldset data-role="controlgroup" data-type="horizontal">';
                    for (var a in set.algs) {
                        var alg = set.algs[a];
                        var id = s + '_' + alg.id;
                        var diag = Display.diagramLLAlg(rot, alg.alg, alg.kind, "5.1em");
                        htm += '<input id="' + id + '" type="checkbox" onchange="settingsUpdate()" data-mini="true" /><label for="' + id + '"><span id="diag_' + id + '">' + diag + '</span></label>';
                    }
                    htm += '</fieldset>';
                    htm += '<a target="_blank" href="' + set.source + '">&#x1f6c8; More info</a>';
                    htm += '</div>';
                }
                document.getElementById("algs").innerHTML = htm;
                $("#options").trigger("create");
            }

            function updateAlgColors() {
                var rot = upColorToRot();
                for (var s in Algs.sets) {
                    var set = Algs.sets[s];
                    for (var a in set.algs) {
                        var alg = set.algs[a];
                        var id = "diag_" + s + '_' + alg.id;
                        var diag = Display.diagramLLAlg(rot, alg.alg, alg.kind, "5.1em");
                        document.getElementById(id).innerHTML = diag;
                    }
                }
            }
        </script>
    </head>
    <body>
        <div id="main" data-role="page">
            <div data-role="header" style="height:40px">
                <a href="#options" class="ui-btn ui-icon-bars ui-btn-icon-notext ui-corner-all"></a>
                <h1><img src="logo_transparent.png" width="22px" height="22px" style="vertical-align: middle; margin-left: -12px; margin-top: -7px" /> Brief Drills</h1>
            </div>
            <div id="diagram" role="main" class="ui-content" style="margin-left: -16px">
                <div id="giiker">
                    <button id="giikerConnect" onclick="nosleep.enable(); Ui.giikerConnect()" class="ui-btn ui-mini">Connect Giiker Supercube</button>
                    <a target="_blank" href="https://amzn.to/2NVExu3" style="padding-left: 20px">I don't have one</a>
                </div>
                <h1 id="status" style="text-align: center; width: 100%; overflow: hidden" style="display: none"></h1>
                <div id="cube" style="text-align: center; margin-top: -80px"></div>
                <div id="debug" style="display: none">
                    <button onclick="Ui.twist('R U R\' U')" class="ui-btn ui-mini ui-corner-all">Su</button>
                    <button onclick="Ui.twist('R U2 R\'')" class="ui-btn ui-mini ui-corner-all">ne</button>
                    <button onclick="Ui.twist('F R U\' R\' U\' R U R\' F\' R U R\' U\' R\' F R F\'')" class="ui-btn ui-mini ui-corner-all">Y-perm</button>
                
                </div>
            </div>
            <div data-role="footer" data-position="fixed" style="height:52px">
                <button id="retry" onclick="Ui.retry()" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-refresh">Retry</button>
                <button id="next" onclick="Ui.next()" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-carat-r">Next</button>
            </div>
            <div id="options" data-role="panel" data-display="overlay">
                <span id="test"></span>
                <div id="giikerDisconnectSection" style="display:none">
                    <button id="giikerDisconnect" onclick="nosleep.disable(); Ui.giikerDisconnect()" class="ui-btn ui-mini" data-mini="true">Disconnect Giiker Supercube</button>
                    <hr />
                </div>
                <label for="auf">Random AUF</label>
                <select id="auf" data-role="slider" data-mini="true" onchange="settingsUpdate()">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
                <label for="simple">Simplified Diagram</label>
                <select id="simple" data-role="slider" data-mini="true" onchange="settingsUpdate()">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
                <fieldset id="upColors" data-role="controlgroup" data-type="horizontal">
                    <legend>Up Colors</legend>
                    <input id="yellow" type="checkbox" value="yellow" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="yellow"><span class="yellow swatch"></span></label>
                    <input id="white" type="checkbox" value="white" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="white"><span class="white swatch"></span></label>
                    <input id="red" type="checkbox" value="red" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="red"><span class="red swatch"></span></label>
                    <input id="orange" type="checkbox" value="orange" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="orange"><span class="orange swatch"></span></label>
                    <input id="green" type="checkbox" value="green" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="green"><span class="green swatch"></span></label>
                    <input id="blue" type="checkbox" value="blue" onchange="settingsUpdate(); updateAlgColors()" data-mini="true" /><label for="blue"><span class="blue swatch"></span></label>
                </fieldset>
                <div id="algs" data-role="collapsibleset" data-mini="true"></div>
                <a href="mailto:feedback@briefcubing.com?Subject=Feedback%20%28v0.1.3%29%0A">Feedback</a>
                <p style="font-size: xx-small; text-align: right">Version 0.1.3 &nbsp;&nbsp; Copyright &copy; Ashley Nathan Feniello&nbsp;</p>
            </div>
        </div>
    </body>
</html>